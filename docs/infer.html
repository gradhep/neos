---

title: neos.infer


keywords: fastai
sidebar: home_sidebar

summary: "Module containing functions for the differentiable calculation of inference metrics."
description: "Module containing functions for the differentiable calculation of inference metrics."
nb_path: "nbs/05_infer.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05_infer.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="expected_CLs" class="doc_header"><code>expected_CLs</code><a href="https://github.com/gradhep/neos/neos/infer.py#L19" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>expected_CLs</code>(<strong><code>model_maker</code></strong>, <strong><code>solver_kwargs</code></strong>)</p>
</blockquote>
<p>Args:
    model_maker: Function that returns a Model object using the <code>params</code> arg.</p>
<p>Returns:
    get_expected_CLs: A callable function that takes the parameters of the observable as argument,
    and returns an expected p-value from testing the background-only model against the
    nominal signal hypothesis (or whatever corresponds to the value of the arg 'test_mu')</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Usage:">Usage:<a class="anchor-link" href="#Usage:"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As before, we need to set up the whole workflow in order to have the required tools to calculate an expected CLs value for one of the example problems.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax.random</span> <span class="kn">import</span> <span class="n">PRNGKey</span>
<span class="kn">from</span> <span class="nn">jax.experimental</span> <span class="kn">import</span> <span class="n">stax</span>

<span class="kn">import</span> <span class="nn">neos</span>
<span class="kn">from</span> <span class="nn">neos.makers</span> <span class="kn">import</span> <span class="n">hists_from_nn</span><span class="p">,</span> <span class="n">histosys_model_from_hists</span>
<span class="kn">from</span> <span class="nn">neos.data</span> <span class="kn">import</span> <span class="n">generate_blobs</span>
<span class="kn">from</span> <span class="nn">neos.fit</span> <span class="kn">import</span> <span class="n">global_fit</span><span class="p">,</span> <span class="n">constrained_fit</span>
<span class="kn">from</span> <span class="nn">neos.infer</span> <span class="kn">import</span> <span class="n">expected_CLs</span>

<span class="c1"># data generator</span>
<span class="n">gen_data</span> <span class="o">=</span> <span class="n">generate_blobs</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">blobs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># nn</span>
<span class="n">init_random_params</span><span class="p">,</span> <span class="n">predict</span> <span class="o">=</span> <span class="n">stax</span><span class="o">.</span><span class="n">serial</span><span class="p">(</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Relu</span><span class="p">,</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Sigmoid</span>
<span class="p">)</span>

<span class="c1"># instantiate model maker</span>
<span class="n">hist_maker</span> <span class="o">=</span> <span class="n">hists_from_nn</span><span class="p">(</span><span class="n">gen_data</span><span class="p">,</span> <span class="n">predict</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">)</span>
<span class="n">model_maker</span> <span class="o">=</span> <span class="n">histosys_model_from_hists</span><span class="p">(</span><span class="n">hist_maker</span><span class="p">)</span>

<span class="c1"># use to make CLs getter!</span>
<span class="n">get_cls</span> <span class="o">=</span> <span class="n">expected_CLs</span><span class="p">(</span><span class="n">model_maker</span><span class="p">,</span> <span class="n">solver_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">pdf_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's evaluate the CLs value for some weight initialization &amp; test value of the model parameter $\mu$:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">network</span> <span class="o">=</span> <span class="n">init_random_params</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">hyperpars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bandwidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="n">get_cls</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">test_mu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hyperparams</span><span class="o">=</span><span class="n">hyperpars</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[DeviceArray(0.12064392, dtype=float64)]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

