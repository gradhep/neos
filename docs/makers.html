---

title: neos.makers


keywords: fastai
sidebar: home_sidebar

summary: "Functions that define the workflow from parametric observable --> statistical model."
description: "Functions that define the workflow from parametric observable --> statistical model."
nb_path: "nbs/02_makers.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/02_makers.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This module contains example workflows to go from the output of a neural network to a differentiable histogram, and to then use that as a basis for statistical modelling via the <a href="https://scikit-hep.org/pyhf/intro.html#histfactory">HistFactory likelihood specification</a>.</p>
<p>These functions are designed to be composed such that a final metric (e.g. expected p-value) is explicitly made a function of the parameters of the neural network. You can see this behaviour through the nested function design; one can specify all other hyperparameters ahead of time when initializing the functions, and the nn weights don't have to be specified until the inner function is called. Keep reading for examples!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="differentiable-histograms-from-neural-networks">differentiable histograms from neural networks<a class="anchor-link" href="#differentiable-histograms-from-neural-networks"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="hists_from_nn" class="doc_header"><code>hists_from_nn</code><a href="https://github.com/gradhep/neos/neos/makers.py#L15" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>hists_from_nn</code>(<strong><code>data_generator</code></strong>, <strong><code>predict</code></strong>, <strong><code>method</code></strong>=<em><code>'softmax'</code></em>, <strong><code>LUMI</code></strong>=<em><code>10</code></em>, <strong><code>sig_scale</code></strong>=<em><code>2</code></em>, <strong><code>bkg_scale</code></strong>=<em><code>10</code></em>)</p>
</blockquote>
<p>Initialize a function <code>hist_maker</code> that returns a 'soft' histogram based
on a neural network with a softmax output. Choose which example problem to
try by setting the <code>example</code> argument.</p>
<p>Args:
    data_generator: Callable that returns generated data (in jax array
                    format).</p>

<pre><code>predict: Decision function for a parameterized observable, e.g. neural
         network.

method: A string to specify the method to use for constructing soft
        histograms. Either "softmax" or "kde".

LUMI: 'Luminosity' scaling factor for the yields.

sig_scale: Individual scaling factor for the signal yields.

bkg_scale: Individual scaling factor for the signal yields.

</code></pre>
<p>Returns:
    hist_maker: A callable function that takes the parameters of the
                observable (and optional hyperpars), then constructs signal,
                background, and background uncertainty yields.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Usage:">Usage:<a class="anchor-link" href="#Usage:"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Begin by instantiating <a href="/neos/makers.html#hists_from_nn"><code>hists_from_nn</code></a> with a function that generates a 3 or 4-tuple of data (we have <a href="/neos/data.html#generate_blobs"><code>generate_blobs</code></a> for this!), and a neural network <code>predict</code> method (takes inputs &amp; weights, returns output)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax.random</span> <span class="kn">import</span> <span class="n">PRNGKey</span>
<span class="kn">from</span> <span class="nn">jax.experimental</span> <span class="kn">import</span> <span class="n">stax</span>

<span class="kn">import</span> <span class="nn">neos</span>
<span class="kn">from</span> <span class="nn">neos.makers</span> <span class="kn">import</span> <span class="n">hists_from_nn</span>
<span class="kn">from</span> <span class="nn">neos.data</span> <span class="kn">import</span> <span class="n">generate_blobs</span>

<span class="c1"># data generator</span>
<span class="n">gen_data</span> <span class="o">=</span> <span class="n">generate_blobs</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">blobs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># nn</span>
<span class="n">init_random_params</span><span class="p">,</span> <span class="n">predict</span> <span class="o">=</span> <span class="n">stax</span><span class="o">.</span><span class="n">serial</span><span class="p">(</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Relu</span><span class="p">,</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Sigmoid</span>
<span class="p">)</span>

<span class="n">hist_maker</span> <span class="o">=</span> <span class="n">hists_from_nn</span><span class="p">(</span><span class="n">gen_data</span><span class="p">,</span> <span class="n">predict</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now, when we initialize our neural network's weights and pass them to <code>hist_maker</code> along with some hyperparameters for the histogram (binning, bandwidth), we should get back a set of event yields:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">network</span> <span class="o">=</span> <span class="n">init_random_params</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">hyperpars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bandwidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="n">hist_maker</span><span class="p">([</span><span class="n">network</span><span class="p">,</span> <span class="n">hyperpars</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[DeviceArray([6.76080181, 6.8832221 ], dtype=float64),
 DeviceArray([34.14177765, 34.12072566], dtype=float64),
 DeviceArray([35.10574108, 33.04116608], dtype=float64),
 DeviceArray([32.32513054, 35.63212448], dtype=float64)]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="statistical-models">statistical models<a class="anchor-link" href="#statistical-models"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="hepdata_like_from_hists" class="doc_header"><code>hepdata_like_from_hists</code><a href="https://github.com/gradhep/neos/neos/makers.py#L266" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>hepdata_like_from_hists</code>(<strong><code>histogram_maker</code></strong>)</p>
</blockquote>
<p>Returns a function that constructs a typical 'hepdata-like' statistical
model with signal, background, and background uncertainty yields when
evaluated at the parameters of the observable.</p>
<p>Args:
    histogram_maker: A function that, when called, returns a secondary function
    that takes the observable's parameters as argument, and returns yields.</p>
<p>Returns:
    nn_model_maker: A function that returns a Model object (either from
    <code>neos.models</code> or from <code>pyhf</code>) when evaluated at the observable's parameters,
    along with the background-only parameters for use in downstream inference.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Usage:">Usage:<a class="anchor-link" href="#Usage:"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax.random</span> <span class="kn">import</span> <span class="n">PRNGKey</span>
<span class="kn">from</span> <span class="nn">jax.experimental</span> <span class="kn">import</span> <span class="n">stax</span>

<span class="kn">import</span> <span class="nn">neos</span>
<span class="kn">from</span> <span class="nn">neos.makers</span> <span class="kn">import</span> <span class="n">hists_from_nn</span><span class="p">,</span> <span class="n">hepdata_like_from_hists</span>
<span class="kn">from</span> <span class="nn">neos.data</span> <span class="kn">import</span> <span class="n">generate_blobs</span>

<span class="c1"># data generator, three blobs only for this model</span>
<span class="n">gen_data</span> <span class="o">=</span> <span class="n">generate_blobs</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">blobs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># nn</span>
<span class="n">init_random_params</span><span class="p">,</span> <span class="n">predict</span> <span class="o">=</span> <span class="n">stax</span><span class="o">.</span><span class="n">serial</span><span class="p">(</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Relu</span><span class="p">,</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Sigmoid</span>
<span class="p">)</span>

<span class="n">hist_maker</span> <span class="o">=</span> <span class="n">hists_from_nn</span><span class="p">(</span><span class="n">gen_data</span><span class="p">,</span> <span class="n">predict</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">)</span>

<span class="c1"># then use this to define your model:</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">hepdata_like_from_hists</span><span class="p">(</span><span class="n">hist_maker</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Similar to above, we can get output at this stage by initializing the neural network. <a href="/neos/makers.html#hepdata_like_from_hists"><code>hepdata_like_from_hists</code></a> will return a <a href="/neos/models.html#Model"><code>Model</code></a> object with callable <code>logpdf</code> method, as well as the model parameters in the background-only scenario for convenience. See <a href="https://scikit-hep.org/pyhf/_generated/pyhf.simplemodels.hepdata_like.html">this link</a> for more about the type of model being used here, as well as the rest of the <code>pyhf</code> docs for added physics context.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">network</span> <span class="o">=</span> <span class="n">init_random_params</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">hyperpars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bandwidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="n">m</span><span class="p">,</span> <span class="n">bkg_only_pars</span> <span class="o">=</span> <span class="n">model</span><span class="p">([</span><span class="n">network</span><span class="p">,</span> <span class="n">hyperpars</span><span class="p">])</span>
<span class="n">m</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">bkg_only_pars</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>DeviceArray([-1338.66123891], dtype=float64)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="histosys_model_from_hists" class="doc_header"><code>histosys_model_from_hists</code><a href="https://github.com/gradhep/neos/neos/makers.py#L292" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>histosys_model_from_hists</code>(<strong><code>histogram_maker</code></strong>)</p>
</blockquote>
<p>Returns a function that constructs a HEP statistical model using a
'histosys' uncertainty for the background (nominal background, up and down
systematic variations) when evaluated at the parameters of the observable.</p>
<p>Args:
    histogram_maker: A function that, when called, returns a secondary function
    that takes the observable's parameters as argument, and returns yields.</p>
<p>Returns:
    nn_model_maker: A function that returns a <code>pyhf.Model</code> object when
    evaluated at the observable's parameters (nn weights), along with the
    background-only parameters for use in downstream inference.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Usage:">Usage:<a class="anchor-link" href="#Usage:"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax.random</span> <span class="kn">import</span> <span class="n">PRNGKey</span>
<span class="kn">from</span> <span class="nn">jax.experimental</span> <span class="kn">import</span> <span class="n">stax</span>

<span class="kn">import</span> <span class="nn">neos</span>
<span class="kn">from</span> <span class="nn">neos.makers</span> <span class="kn">import</span> <span class="n">hists_from_nn</span><span class="p">,</span> <span class="n">histosys_model_from_hists</span>
<span class="kn">from</span> <span class="nn">neos.data</span> <span class="kn">import</span> <span class="n">generate_blobs</span>

<span class="c1"># data generator, four blobs only for this model</span>
<span class="n">gen_data</span> <span class="o">=</span> <span class="n">generate_blobs</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">blobs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># nn</span>
<span class="n">init_random_params</span><span class="p">,</span> <span class="n">predict</span> <span class="o">=</span> <span class="n">stax</span><span class="o">.</span><span class="n">serial</span><span class="p">(</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Relu</span><span class="p">,</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">stax</span><span class="o">.</span><span class="n">Sigmoid</span>
<span class="p">)</span>

<span class="n">hist_maker</span> <span class="o">=</span> <span class="n">hists_from_nn</span><span class="p">(</span><span class="n">gen_data</span><span class="p">,</span> <span class="n">predict</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">)</span>

<span class="c1"># then use this to define your model:</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">histosys_model_from_hists</span><span class="p">(</span><span class="n">hist_maker</span><span class="p">)</span>

<span class="n">_</span><span class="p">,</span> <span class="n">network</span> <span class="o">=</span> <span class="n">init_random_params</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">hyperpars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bandwidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="c1"># instantiate model and eval logpdf</span>
<span class="n">m</span><span class="p">,</span> <span class="n">bkg_only_pars</span> <span class="o">=</span> <span class="n">model</span><span class="p">([</span><span class="n">network</span><span class="p">,</span> <span class="n">hyperpars</span><span class="p">])</span>
<span class="n">m</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">bkg_only_pars</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>DeviceArray([-62.62101506], dtype=float64)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

